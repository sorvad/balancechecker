<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>Balance Checker</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQmFsYW5jZSBDaGVja2VyIiwic2hvcnRfbmFtZSI6IkJhbGFuY2UiLCJkZXNjcmlwdGlvbiI6IkZpbmFuY2lhbCBwcm9qZWN0aW9uIHN5c3RlbSIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMGEwYSIsInRoZW1lX2NvbG9yIjoiIzBhMGEwYSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQtcHJpbWFyeSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE9USWdNVGt5SWo0OGNtVmpkQ0IzYVdSMGFEMGlNVGt5SWlCb1pXbG5hSFE5SWpFNU1pSWdabWxzYkQwaUl6QmhNR0V3WVNJdlBqeDBaWGgwSUhnOUlqazJJaUI1UFNJNU5pSWdabWxzYkQwaUl6QXdabVkwTVNJZ1ptOXVkQzFtWVcxcGJIazlJbU52ZFhKcFpYSWlJR1p2Ym5RdGMybDZaVDBpTmpRaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQanBoUEM5MFpYaDBQand2YzNablBnPT0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9LHsic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQTFNVElnTlRFeUlqNDhjbVZqZENCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlnWm1sc2JEMGlJekJoTUdFd1lTSXZQangwWlhoMElIZzlJakkxTmlJZ2VUMGlNalUySWlCbWFXeHNQU0lqTURCbVpqUXhJaUJtYjI1MExXWmhiV2xzZVQwaVkyOTFjbWxsY2lJZ1ptOXVkQzF6YVhwbFBTSXhNVEFpSUhSbGVIUXRZVzVqYUc5eVBTSnRhV1JrYkdVaVBucGhQQzkwWlhoMFBqd3ZjM1puUGc9PSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent-green: #00ff41;
            --accent-red: #ff1744;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Courier New', Courier, monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            opacity: 0;
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes fadeIn { to { opacity: 1; } }

        header {
            border: 2px solid var(--accent-green);
            padding: 20px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,65,0.1), transparent);
            animation: scan 3s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        h1 {
            font-size: clamp(24px, 5vw, 48px);
            font-weight: 700;
            color: var(--accent-green);
            text-transform: uppercase;
            position: relative;
        }

        h1::after { content: '_'; animation: blink 1s step-end infinite; }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
        }

        .input-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 30px;
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--accent-green);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 18px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0,255,65,0.2);
        }

        button {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            font-weight: 700;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,255,65,0.3);
        }

        button:active { transform: translateY(0); }

        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .results { display: none; }
        .results.show { display: block; animation: slideUp 0.5s ease-out; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .balance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .balance-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px; height: 100%;
            background: var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .balance-card.warning::before { background: var(--accent-red); }

        .balance-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .balance-card.warning .balance-value { color: var(--accent-red); }

        .balance-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .transactions-table {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }

        thead {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            color: var(--accent-green);
            border-bottom: 2px solid var(--border);
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        tbody tr:hover { background: var(--bg-tertiary); }
        tbody tr.income { background: rgba(0,255,65,0.05); }
        tbody tr.overdraft { background: rgba(255,23,68,0.1); }

        td { padding: 12px 10px; }

        .direction-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .direction-in { background: var(--accent-green); color: var(--bg-primary); }
        .direction-out { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }

        .amount { font-weight: 700; }
        .amount.negative { color: var(--text-primary); }
        .amount.positive { color: var(--accent-green); }

        .balance-col { font-weight: 700; font-size: 14px; }
        .balance-col.warning { color: var(--accent-red); }

        .frequency { color: var(--text-secondary); font-size: 11px; }

        .loading { display: none; text-align: center; padding: 40px; color: var(--text-secondary); }
        .loading.show { display: block; }

        .spinner {
            display: inline-block;
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            body { padding: 10px; }
            header { padding: 15px; }
            .input-section { padding: 20px; }
            table { font-size: 11px; }
            th, td { padding: 8px 5px; }
            .balance-value { font-size: 22px; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Balance Checker</h1>
            <div class="subtitle">Projects your balance from tomorrow through end of current month</div>
        </header>

        <div class="input-section" id="inputSection">
            <label for="balance">Current Account Balance (£)</label>
            <input type="number" id="balance" step="0.01" placeholder="0.00" autofocus>
            <button onclick="calculateBalance()">Calculate Projections</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top:15px;">Processing transactions...</p>
        </div>

        <div class="results" id="results">
            <div class="balance-summary">
                <div class="balance-card">
                    <div class="balance-label">Starting Balance</div>
                    <div class="balance-value" id="startBalance">£0.00</div>
                    <div class="balance-date" id="startDate"></div>
                </div>
                <div class="balance-card" id="endBalanceCard">
                    <div class="balance-label">Projected End Balance</div>
                    <div class="balance-value" id="endBalance">£0.00</div>
                    <div class="balance-date" id="daysRemaining">End of month</div>
                </div>
            </div>

            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Dir</th>
                            <th class="hide-mobile">Frequency</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody"></tbody>
                </table>
            </div>

            <button class="secondary" onclick="resetCalculation()" style="margin-top:30px;">New Calculation</button>
        </div>
    </div>

    <script>
    // ============================================================
    // INLINE SERVICE WORKER - no external file needed
    // ============================================================
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE = 'bc-v3';
            self.addEventListener('install', e => {
                self.skipWaiting();
                e.waitUntil(
                    caches.open(CACHE).then(c => c.add(location.href))
                );
            });
            self.addEventListener('activate', e => {
                e.waitUntil(
                    caches.keys().then(keys =>
                        Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
                    ).then(() => self.clients.claim())
                );
            });
            self.addEventListener('fetch', e => {
                e.respondWith(
                    caches.match(e.request).then(cached => cached || fetch(e.request).then(res => {
                        if (!res.ok) return res;
                        const clone = res.clone();
                        caches.open(CACHE).then(c => c.put(e.request, clone));
                        return res;
                    })).catch(() => caches.match(location.href))
                );
            });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        navigator.serviceWorker.register(URL.createObjectURL(blob)).then(() => {
            console.log('Service worker registered (inline)');
        }).catch(e => console.log('SW failed:', e));
    }

    // ============================================================
    // TRANSACTION CLASSES
    // ============================================================
    class Transaction {
        constructor(name, direction, amount) {
            this.name = name;
            this.direction = direction;
            this.amount = amount;
        }
        get frequency() { return 'Unknown'; }
        shouldProcess(date) { return false; }
    }

    class DailyTransaction extends Transaction {
        get frequency() { return 'Daily'; }
        shouldProcess() { return true; }
    }

    class GroupTransaction extends Transaction {
        get frequency() { return 'For Period'; }
        shouldProcess() { return true; }
    }

    class MonthlyTransaction extends Transaction {
        constructor(name, direction, amount, dayOfMonth) {
            super(name, direction, amount);
            this.dayOfMonth = dayOfMonth;
        }

        get frequency() {
            return `Monthly (${this.dayOfMonth}${getDaySuffix(this.dayOfMonth)})`;
        }

        shouldProcess(date) {
            const dow = date.getDay(); // 0=Sun 1=Mon ... 5=Fri 6=Sat
            const isWeekend = dow === 0 || dow === 6;

            if (this.direction === 'IN') {
                if (isWeekend) return false;
                if (dow === 5) { // Friday - pull in weekend dates
                    return date.getDate() === this.dayOfMonth ||
                           date.getDate() + 1 === this.dayOfMonth ||
                           date.getDate() + 2 === this.dayOfMonth;
                }
                return date.getDate() === this.dayOfMonth;
            } else { // OUT
                if (isWeekend) return false;
                if (dow === 1) { // Monday - push back weekend dates
                    const sun = new Date(date); sun.setDate(date.getDate() - 1);
                    const sat = new Date(date); sat.setDate(date.getDate() - 2);
                    return date.getDate() === this.dayOfMonth ||
                           sun.getDate() === this.dayOfMonth ||
                           sat.getDate() === this.dayOfMonth;
                }
                return date.getDate() === this.dayOfMonth;
            }
        }
    }

    class EndOfMonthTransaction extends Transaction {
        get frequency() { return 'End of Month'; }

        shouldProcess(date) {
            if (this.direction !== 'IN') return false;
            const dow = date.getDay();
            if (dow === 0 || dow === 6) return false; // weekend

            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

            if (dow === 5) { // Friday
                return date.getDate() === lastDay ||
                       date.getDate() + 1 === lastDay ||
                       date.getDate() + 2 === lastDay;
            }
            return date.getDate() === lastDay;
        }
    }

    class ThreeMonthlyTransaction extends Transaction {
        constructor(name, direction, amount, dayOfMonth, startMonth) {
            super(name, direction, amount);
            this.dayOfMonth = dayOfMonth;
            this.startMonth = startMonth;
        }

        get frequency() {
            const months = [0, 3, 6, 9].map(offset => {
                const m = ((this.startMonth - 1 + offset) % 12);
                return new Date(2000, m).toLocaleDateString('en', { month: 'short' });
            }).join(', ');
            return `3 Monthly (${months})`;
        }

        shouldProcess(date) {
            const validMonths = [0, 3, 6, 9].map(offset => ((this.startMonth - 1 + offset) % 12) + 1);
            return validMonths.includes(date.getMonth() + 1) && date.getDate() === this.dayOfMonth;
        }
    }

    class YearlyTransaction extends Transaction {
        constructor(name, direction, amount, dayOfMonth, month) {
            super(name, direction, amount);
            this.dayOfMonth = dayOfMonth;
            this.month = month;
        }

        get frequency() {
            const monthName = new Date(2000, this.month - 1).toLocaleDateString('en', { month: 'long' });
            return `Yearly (${this.dayOfMonth}${getDaySuffix(this.dayOfMonth)} of ${monthName})`;
        }

        shouldProcess(date) {
            return date.getDate() === this.dayOfMonth && date.getMonth() + 1 === this.month;
        }
    }

    function getDaySuffix(day) {
        if (day >= 11 && day <= 13) return 'th';
        switch (day % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    }

    // ============================================================
    // SETUP TRANSACTIONS
    // ============================================================
    function setupTransactions() {
        return [
            // Outgoings
            new DailyTransaction("Weekly Shop", "OUT", 27),
            new DailyTransaction("Petrol", "OUT", 3.6),
            new MonthlyTransaction("TV License", "OUT", 13, 1),
            new MonthlyTransaction("Internet", "OUT", 24, 15),
            new MonthlyTransaction("Google Drive", "OUT", 7.99, 11),
            new MonthlyTransaction("Gas and Elec.", "OUT", 215, 1),
            new MonthlyTransaction("Steve Car ins.", "OUT", 22, 8),
            new MonthlyTransaction("Mortgage", "OUT", 240, 28),
            new MonthlyTransaction("Mob Phones", "OUT", 20, 27),
            new MonthlyTransaction("Water", "OUT", 19, 1),
            new MonthlyTransaction("Council Tax", "OUT", 143, 16),
            new MonthlyTransaction("House ins.", "OUT", 17, 3),
            new MonthlyTransaction("Old credit cards", "OUT", 3, 1),
            new MonthlyTransaction("Car Tax", "OUT", 14, 1),
            new MonthlyTransaction("New Credit Debt", "OUT", 11, 27),
            new MonthlyTransaction("Lotto", "OUT", 10, 24),
            new MonthlyTransaction("Boiler Ins.", "OUT", 25, 22),
            new MonthlyTransaction("Disney Plus", "OUT", 9, 24),
            new MonthlyTransaction("Netflix", "OUT", 11, 22),
            new MonthlyTransaction("AA Home Ins.", "OUT", 31, 25),
            new MonthlyTransaction("Elliot Bus", "OUT", 78, 4),
            new MonthlyTransaction("Elliot Trust Fund", "OUT", 50, 1),
            new ThreeMonthlyTransaction("Just Host", "OUT", 60, 25, 1),
            new YearlyTransaction("Domain reg xtron", "OUT", 35, 14, 4),
            new YearlyTransaction("Domain renewal", "OUT", 15, 28, 3),
            // Income
            new EndOfMonthTransaction("Uni Wage", "IN", 2260),
            new MonthlyTransaction("Pension", "IN", 500, 9),
            new MonthlyTransaction("Harry Rent", "IN", 220, 28)
        ];
    }

    // ============================================================
    // PROCESS TRANSACTIONS
    // ============================================================
    function processTransactions(transactions, startBalance, startDate) {
        const results = [];
        let balance = startBalance;
        const grouped = {};

        const lastDay = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
        let current = new Date(startDate);

        while (current <= lastDay) {
            for (const t of transactions) {
                if (!t.shouldProcess(current)) continue;

                // Group daily transactions (except Weekly Shop) into one total
                if (t instanceof DailyTransaction && t.name !== "Weekly Shop") {
                    if (!grouped[t.name]) grouped[t.name] = { t: t, amount: 0 };
                    grouped[t.name].amount += t.amount;
                } else {
                    balance += (t.direction === 'OUT' ? -t.amount : t.amount);
                    results.push({ transaction: t, date: new Date(current), balance: balance });
                }
            }
            current.setDate(current.getDate() + 1);
        }

        // Append grouped daily totals at the end
        for (const [name, data] of Object.entries(grouped)) {
            const gt = new GroupTransaction(name, data.t.direction, data.amount);
            balance += (gt.direction === 'OUT' ? -gt.amount : gt.amount);
            results.push({ transaction: gt, date: lastDay, balance: balance });
        }

        return results;
    }

    // ============================================================
    // UI
    // ============================================================
    function calculateBalance() {
        const val = document.getElementById('balance').value;
        if (!val) { alert('Please enter a balance'); return; }

        const balance = parseFloat(val);
        const startDate = new Date();
        startDate.setDate(startDate.getDate() + 1); // tomorrow, matching original C# logic

        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('loading').classList.add('show');

        setTimeout(() => {
            const results = processTransactions(setupTransactions(), balance, startDate);

            document.getElementById('startBalance').textContent = `£${balance.toFixed(2)}`;
            document.getElementById('startDate').textContent = startDate.toLocaleDateString('en-GB');

            const endBal = results.length > 0 ? results[results.length - 1].balance : balance;
            document.getElementById('endBalance').textContent = `£${endBal.toFixed(2)}`;

            const lastDay = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
            const daysLeft = lastDay.getDate() - startDate.getDate() + 1;
            document.getElementById('daysRemaining').textContent = daysLeft === 1 ? '1 day remaining' : `${daysLeft} days remaining`;

            const card = document.getElementById('endBalanceCard');
            card.classList.toggle('warning', endBal < -2000);

            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';

            results.forEach(r => {
                const row = tbody.insertRow();
                if (r.transaction.direction === 'IN') row.classList.add('income');
                if (r.balance < -2000) row.classList.add('overdraft');

                const dateStr = r.date.toLocaleDateString('en-GB');
                console.log('Adding row:', r.transaction.name, 'Date:', dateStr);

                row.innerHTML = `
                    <td>${r.transaction.name}</td>
                    <td><span class="direction-badge direction-${r.transaction.direction.toLowerCase()}">${r.transaction.direction}</span></td>
                    <td class="frequency hide-mobile">${r.transaction.frequency}</td>
                    <td class="amount ${r.transaction.direction === 'OUT' ? 'negative' : 'positive'}">£${r.transaction.amount.toFixed(2)}</td>
                    <td class="balance-col ${r.balance < -2000 ? 'warning' : ''}">£${r.balance.toFixed(2)}</td>
                    <td style="font-weight:bold;color:var(--accent-green);">${dateStr}</td>
                `;
            });

            document.getElementById('loading').classList.remove('show');
            document.getElementById('results').classList.add('show');
        }, 400);
    }

    function resetCalculation() {
        document.getElementById('results').classList.remove('show');
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('balance').value = '';
        document.getElementById('balance').focus();
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Enter' && document.activeElement.id === 'balance') calculateBalance();
    });
    </script>
</body>
</html>
