<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>Balance Checker</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent-green: #00ff41;
            --accent-red: #ff1744;
            --accent-yellow: #ffc107;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Courier New', Courier, monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        header {
            border: 2px solid var(--accent-green);
            padding: 20px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: clamp(24px, 5vw, 48px);
            font-weight: 700;
            color: var(--accent-green);
            text-transform: uppercase;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 10px 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            font-weight: 700;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            cursor: pointer;
            text-transform: uppercase;
        }

        .header-btn:hover { border-color: var(--accent-green); }
        .header-btn.active { border-color: var(--accent-green); background: var(--bg-secondary); }

        .input-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 30px;
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--accent-green);
            text-transform: uppercase;
            font-size: 12px;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        input:focus, select:focus {
            border-color: var(--accent-green);
            outline: none;
        }

        select option {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        button {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            font-weight: 700;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            margin-top: 10px;
        }

        button:active { transform: scale(0.98); }

        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        button.danger {
            background: var(--accent-red);
            color: var(--text-primary);
        }

        button.small {
            width: auto;
            padding: 5px 10px;
            font-size: 11px;
            margin: 0;
        }

        .results { display: none; }
        .results.show { display: block; }

        .balance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .balance-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 20px;
        }

        .balance-card.warning { border-color: var(--accent-red); }

        .balance-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .balance-card.warning .balance-value { color: var(--accent-red); }

        .transactions-table {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }

        thead {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            color: var(--accent-green);
            border-bottom: 2px solid var(--border);
        }

        tbody tr { border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: var(--bg-tertiary); }
        tbody tr.income { background: rgba(0,255,65,0.05); }
        tbody tr.overdraft { background: rgba(255,23,68,0.1); }

        td { padding: 10px 8px; }

        .dir-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
        }

        .dir-in { background: var(--accent-green); color: var(--bg-primary); }
        .dir-out { background: var(--bg-tertiary); border: 1px solid var(--border); }

        .amt { font-weight: 700; }
        .amt.out { color: var(--text-primary); }
        .amt.in { color: var(--accent-green); }

        .bal { font-weight: 700; }
        .bal.warn { color: var(--accent-red); }

        /* Transaction Editor Styles */
        .editor-section {
            display: none;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 20px;
            margin-bottom: 30px;
        }

        .editor-section.show { display: block; }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .editor-header h2 {
            color: var(--accent-green);
            font-size: 18px;
            text-transform: uppercase;
        }

        .trans-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .trans-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
            background: var(--bg-primary);
        }

        .trans-item:hover { border-color: var(--accent-green); }

        .trans-info {
            flex: 1;
        }

        .trans-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .trans-details {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .trans-actions {
            display: flex;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
        }

        .conditional-fields {
            display: none;
        }

        .conditional-fields.show {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-green);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: var(--accent-green);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            table { font-size: 11px; }
            th, td { padding: 8px 4px; }
            .hide-mobile { display: none; }
            header { flex-direction: column; align-items: flex-start; }
            .header-buttons { width: 100%; }
            .header-btn { flex: 1; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h4>Balance Checker</h4>
            </div>
            <div class="header-buttons">
                <button class="header-btn active" id="calcTab" onclick="showTab('calc')">Calculate</button>
                <button class="header-btn" id="editTab" onclick="showTab('edit')">Edit Data</button>
            </div>
        </header>

        <div class="input-section" id="inputSection">
            <label for="balance">Current Balance (£)</label>
            <input type="number" id="balance" step="0.01" placeholder="0.00" autofocus>
            <button onclick="calc()">Calculate</button>
        </div>

        <div class="results" id="results">
            <div class="balance-summary">
                <div class="balance-card">
                    <div class="balance-label">Start</div>
                    <div class="balance-value" id="start">£0.00</div>
                </div>
                <div class="balance-card" id="endCard">
                    <div class="balance-label">End</div>
                    <div class="balance-value" id="end">£0.00</div>
                </div>
            </div>

            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Dir</th>
                            <th class="hide-mobile">Frequency</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

            <button class="secondary" onclick="reset()">New Calculation</button>
        </div>

        <!-- Transaction Editor Section -->
        <div class="editor-section" id="editorSection">
            <div class="editor-header">
                <h2>Manage Transactions</h2>
                <button class="small" onclick="openAddModal()">+ Add New</button>
            </div>

            <div class="trans-list" id="transList"></div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="secondary" onclick="exportData()" style="flex: 1; min-width: 150px;">Export JSON</button>
                <button class="secondary" onclick="document.getElementById('importFile').click()" style="flex: 1; min-width: 150px;">Import JSON</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="danger" onclick="resetToDefaults()" style="flex: 1; min-width: 150px;">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="transModal">
        <div class="modal">
            <h3 id="modalTitle">Add Transaction</h3>
            <form id="transForm" onsubmit="saveTransaction(event)">
                <input type="hidden" id="editIndex" value="-1">

                <div class="form-group">
                    <label for="transName">Name</label>
                    <input type="text" id="transName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="transDir">Direction</label>
                        <select id="transDir" required>
                            <option value="OUT">OUT (Expense)</option>
                            <option value="IN">IN (Income)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transAmt">Amount (£)</label>
                        <input type="number" id="transAmt" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="transType">Frequency Type</label>
                    <select id="transType" required onchange="updateConditionalFields()">
                        <option value="Daily">Daily</option>
                        <option value="Monthly">Monthly (specific day)</option>
                        <option value="EndMonth">End of Month</option>
                        <option value="ThreeMonthly">Every 3 Months</option>
                        <option value="Yearly">Yearly</option>
                    </select>
                </div>

                <div class="conditional-fields" id="monthlyFields">
                    <div class="form-group">
                        <label for="transDay">Day of Month (1-31)</label>
                        <input type="number" id="transDay" min="1" max="31" value="1">
                    </div>
                </div>

                <div class="conditional-fields" id="threeMonthlyFields">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transDay3">Day of Month</label>
                            <input type="number" id="transDay3" min="1" max="31" value="1">
                        </div>
                        <div class="form-group">
                            <label for="transStartMon">Starting Month</label>
                            <select id="transStartMon">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="conditional-fields" id="yearlyFields">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transDayY">Day</label>
                            <input type="number" id="transDayY" min="1" max="31" value="1">
                        </div>
                        <div class="form-group">
                            <label for="transMonY">Month</label>
                            <select id="transMonY">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" style="flex: 1;">Save</button>
                    <button type="button" class="secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('✅ ServiceWorker registered successfully');
                })
                .catch(err => {
                    console.error('❌ ServiceWorker registration failed:', err);
                });
        });
    }

    // Default transactions data
    const DEFAULT_TRANSACTIONS = [
        { type: "Daily", name: "Weekly Shop", dir: "OUT", amt: 27 },
        { type: "Daily", name: "Petrol", dir: "OUT", amt: 3.6 },
        { type: "Monthly", name: "TV License", dir: "OUT", amt: 13, day: 1 },
        { type: "Monthly", name: "Internet", dir: "OUT", amt: 24, day: 15 },
        { type: "Monthly", name: "Google Drive", dir: "OUT", amt: 7.99, day: 11 },
        { type: "Monthly", name: "Gas & Elec", dir: "OUT", amt: 215, day: 1 },
        { type: "Monthly", name: "Car Ins", dir: "OUT", amt: 22, day: 8 },
        { type: "Monthly", name: "Mortgage", dir: "OUT", amt: 240, day: 28 },
        { type: "Monthly", name: "Phones", dir: "OUT", amt: 20, day: 27 },
        { type: "Monthly", name: "Water", dir: "OUT", amt: 19, day: 1 },
        { type: "Monthly", name: "Council Tax", dir: "OUT", amt: 143, day: 16 },
        { type: "Monthly", name: "House Ins", dir: "OUT", amt: 17, day: 3 },
        { type: "Monthly", name: "Credit Cards", dir: "OUT", amt: 3, day: 1 },
        { type: "Monthly", name: "Car Tax", dir: "OUT", amt: 14, day: 1 },
        { type: "Monthly", name: "Credit Debt", dir: "OUT", amt: 11, day: 27 },
        { type: "Monthly", name: "Lotto", dir: "OUT", amt: 10, day: 24 },
        { type: "Monthly", name: "Boiler", dir: "OUT", amt: 25, day: 22 },
        { type: "Monthly", name: "Disney+", dir: "OUT", amt: 9, day: 24 },
        { type: "Monthly", name: "Netflix", dir: "OUT", amt: 11, day: 22 },
        { type: "Monthly", name: "AA Home", dir: "OUT", amt: 31, day: 25 },
        { type: "Monthly", name: "Bus Pass", dir: "OUT", amt: 78, day: 4 },
        { type: "Monthly", name: "Trust Fund", dir: "OUT", amt: 50, day: 1 },
        { type: "ThreeMonthly", name: "Hosting", dir: "OUT", amt: 60, day: 25, startMon: 1 },
        { type: "Yearly", name: "Domain 1", dir: "OUT", amt: 35, day: 14, mon: 4 },
        { type: "Yearly", name: "Domain 2", dir: "OUT", amt: 15, day: 28, mon: 3 },
        { type: "EndMonth", name: "Wage", dir: "IN", amt: 2260 },
        { type: "Monthly", name: "Pension", dir: "IN", amt: 500, day: 9 },
        { type: "Monthly", name: "Rent", dir: "IN", amt: 220, day: 28 }
    ];

    // Storage key
    const STORAGE_KEY = 'balanceChecker_transactions';

    // Load transactions from localStorage or use defaults
    function loadTransactions() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                return JSON.parse(stored);
            } catch (e) {
                console.error('Failed to parse stored transactions:', e);
            }
        }
        return [...DEFAULT_TRANSACTIONS];
    }

    // Save transactions to localStorage
    function saveTransactions(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Current transaction data
    let transactionData = loadTransactions();

    // Transaction Classes (same as before)
    class Transaction {
        constructor(name, dir, amt) {
            this.name = name;
            this.dir = dir;
            this.amt = amt;
        }
        get freq() { return ''; }
        test(d) { return false; }
    }

    class Daily extends Transaction {
        get freq() { return 'Daily'; }
        test() { return true; }
    }

    class Group extends Transaction {
        get freq() { return 'For Period'; }
        test() { return true; }
    }

    class Monthly extends Transaction {
        constructor(name, dir, amt, day) {
            super(name, dir, amt);
            this.day = day;
        }
        get freq() {
            const s = this.day >= 11 && this.day <= 13 ? 'th' : ['th','st','nd','rd'][this.day%10] || 'th';
            return `Monthly (${this.day}${s})`;
        }
        test(d) {
            const dow = d.getDay();
            const weekend = dow === 0 || dow === 6;
            if (this.dir === 'IN') {
                if (weekend) return false;
                if (dow === 5) return d.getDate() === this.day || d.getDate()+1 === this.day || d.getDate()+2 === this.day;
                return d.getDate() === this.day;
            } else {
                if (weekend) return false;
                if (dow === 1) {
                    const sun = new Date(d); sun.setDate(d.getDate()-1);
                    const sat = new Date(d); sat.setDate(d.getDate()-2);
                    return d.getDate() === this.day || sun.getDate() === this.day || sat.getDate() === this.day;
                }
                return d.getDate() === this.day;
            }
        }
    }

    class EndMonth extends Transaction {
        get freq() { return 'End of Month'; }
        test(d) {
            if (this.dir !== 'IN') return false;
            const dow = d.getDay();
            if (dow === 0 || dow === 6) return false;
            const last = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
            if (dow === 5) return d.getDate() === last || d.getDate()+1 === last || d.getDate()+2 === last;
            return d.getDate() === last;
        }
    }

    class ThreeMonthly extends Transaction {
        constructor(name, dir, amt, day, startMon) {
            super(name, dir, amt);
            this.day = day;
            this.startMon = startMon;
        }
        get freq() {
            const ms = [0,3,6,9].map(o => new Date(2000, (this.startMon-1+o)%12).toLocaleDateString('en',{month:'short'})).join(',');
            return `3 Monthly (${ms})`;
        }
        test(d) {
            const valid = [0,3,6,9].map(o => ((this.startMon-1+o)%12)+1);
            return valid.includes(d.getMonth()+1) && d.getDate() === this.day;
        }
    }

    class Yearly extends Transaction {
        constructor(name, dir, amt, day, mon) {
            super(name, dir, amt);
            this.day = day;
            this.mon = mon;
        }
        get freq() {
            const mn = new Date(2000, this.mon-1).toLocaleDateString('en',{month:'long'});
            const s = this.day >= 11 && this.day <= 13 ? 'th' : ['th','st','nd','rd'][this.day%10] || 'th';
            return `Yearly (${this.day}${s} ${mn})`;
        }
        test(d) {
            return d.getDate() === this.day && d.getMonth()+1 === this.mon;
        }
    }

    // Convert data to Transaction objects
    function dataToTransactions(data) {
        return data.map(t => {
            switch (t.type) {
                case 'Daily': return new Daily(t.name, t.dir, t.amt);
                case 'Monthly': return new Monthly(t.name, t.dir, t.amt, t.day);
                case 'EndMonth': return new EndMonth(t.name, t.dir, t.amt);
                case 'ThreeMonthly': return new ThreeMonthly(t.name, t.dir, t.amt, t.day, t.startMon);
                case 'Yearly': return new Yearly(t.name, t.dir, t.amt, t.day, t.mon);
                default: return new Daily(t.name, t.dir, t.amt);
            }
        });
    }

    // Process transactions
    function process(bal, start) {
        const trans = dataToTransactions(transactionData);
        const res = [];
        const grp = {};
        const last = new Date(start.getFullYear(), start.getMonth()+1, 0);
        let d = new Date(start);

        while (d <= last) {
            for (const t of trans) {
                if (!t.test(d)) continue;
                if (t instanceof Daily && t.name !== "Weekly Shop") {
                    if (!grp[t.name]) grp[t.name] = {t, amt:0};
                    grp[t.name].amt += t.amt;
                } else {
                    bal += t.dir === 'OUT' ? -t.amt : t.amt;
                    res.push({t, d: new Date(d), bal});
                }
            }
            d.setDate(d.getDate()+1);
        }

        for (const [name, data] of Object.entries(grp)) {
            const gt = new Group(name, data.t.dir, data.amt);
            bal += gt.dir === 'OUT' ? -gt.amt : gt.amt;
            res.push({t: gt, d: last, bal});
        }

        return res;
    }

    // Tab switching
    function showTab(tab) {
        document.getElementById('calcTab').classList.toggle('active', tab === 'calc');
        document.getElementById('editTab').classList.toggle('active', tab === 'edit');

        document.getElementById('inputSection').style.display = tab === 'calc' ? 'block' : 'none';
        document.getElementById('results').classList.remove('show');
        document.getElementById('editorSection').classList.toggle('show', tab === 'edit');

        if (tab === 'edit') {
            renderTransactionList();
        }
    }

    // Render transaction list in editor
    function renderTransactionList() {
        const list = document.getElementById('transList');
        list.innerHTML = '';

        transactionData.forEach((t, index) => {
            const item = document.createElement('div');
            item.className = 'trans-item';
            item.innerHTML = `
                <div class="trans-info">
                    <div class="trans-name">
                        <span class="dir-badge dir-${t.dir.toLowerCase()}">${t.dir}</span>
                        ${t.name}
                    </div>
                    <div class="trans-details">
                        £${t.amt.toFixed(2)} · ${getFrequencyLabel(t)}
                    </div>
                </div>
                <div class="trans-actions">
                    <button class="small" onclick="editTransaction(${index})">Edit</button>
                    <button class="small danger" onclick="deleteTransaction(${index})">Del</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    // Get frequency label for display
    function getFrequencyLabel(t) {
        switch (t.type) {
            case 'Daily': return 'Daily';
            case 'Monthly': return `Monthly (${t.day}${getOrdinal(t.day)})`;
            case 'EndMonth': return 'End of Month';
            case 'ThreeMonthly':
                const ms = [0,3,6,9].map(o => new Date(2000, (t.startMon-1+o)%12).toLocaleDateString('en',{month:'short'})).join(', ');
                return `3 Monthly (${ms})`;
            case 'Yearly':
                const mn = new Date(2000, t.mon-1).toLocaleDateString('en',{month:'short'});
                return `Yearly (${t.day}${getOrdinal(t.day)} ${mn})`;
            default: return t.type;
        }
    }

    function getOrdinal(n) {
        return n >= 11 && n <= 13 ? 'th' : ['th','st','nd','rd'][n%10] || 'th';
    }

    // Modal functions
    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'Add Transaction';
        document.getElementById('editIndex').value = -1;
        document.getElementById('transForm').reset();
        document.getElementById('transType').value = 'Monthly';
        updateConditionalFields();
        document.getElementById('transModal').classList.add('show');
    }

    function editTransaction(index) {
        const t = transactionData[index];
        document.getElementById('modalTitle').textContent = 'Edit Transaction';
        document.getElementById('editIndex').value = index;
        document.getElementById('transName').value = t.name;
        document.getElementById('transDir').value = t.dir;
        document.getElementById('transAmt').value = t.amt;
        document.getElementById('transType').value = t.type;

        if (t.type === 'Monthly') {
            document.getElementById('transDay').value = t.day;
        } else if (t.type === 'ThreeMonthly') {
            document.getElementById('transDay3').value = t.day;
            document.getElementById('transStartMon').value = t.startMon;
        } else if (t.type === 'Yearly') {
            document.getElementById('transDayY').value = t.day;
            document.getElementById('transMonY').value = t.mon;
        }

        updateConditionalFields();
        document.getElementById('transModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('transModal').classList.remove('show');
    }

    function updateConditionalFields() {
        const type = document.getElementById('transType').value;
        document.getElementById('monthlyFields').classList.toggle('show', type === 'Monthly');
        document.getElementById('threeMonthlyFields').classList.toggle('show', type === 'ThreeMonthly');
        document.getElementById('yearlyFields').classList.toggle('show', type === 'Yearly');
    }

    function saveTransaction(e) {
        e.preventDefault();

        const index = parseInt(document.getElementById('editIndex').value);
        const type = document.getElementById('transType').value;

        const newTrans = {
            type: type,
            name: document.getElementById('transName').value.trim(),
            dir: document.getElementById('transDir').value,
            amt: parseFloat(document.getElementById('transAmt').value)
        };

        if (type === 'Monthly') {
            newTrans.day = parseInt(document.getElementById('transDay').value);
        } else if (type === 'ThreeMonthly') {
            newTrans.day = parseInt(document.getElementById('transDay3').value);
            newTrans.startMon = parseInt(document.getElementById('transStartMon').value);
        } else if (type === 'Yearly') {
            newTrans.day = parseInt(document.getElementById('transDayY').value);
            newTrans.mon = parseInt(document.getElementById('transMonY').value);
        }

        if (index === -1) {
            transactionData.push(newTrans);
        } else {
            transactionData[index] = newTrans;
        }

        saveTransactions(transactionData);
        closeModal();
        renderTransactionList();
    }

    function deleteTransaction(index) {
        if (confirm(`Delete "${transactionData[index].name}"?`)) {
            transactionData.splice(index, 1);
            saveTransactions(transactionData);
            renderTransactionList();
        }
    }

    // Export/Import
    function exportData() {
        const dataStr = JSON.stringify(transactionData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'balance-checker-data.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const imported = JSON.parse(evt.target.result);
                if (Array.isArray(imported)) {
                    transactionData = imported;
                    saveTransactions(transactionData);
                    renderTransactionList();
                    alert('Data imported successfully!');
                } else {
                    alert('Invalid data format');
                }
            } catch (err) {
                alert('Failed to parse JSON file');
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    }

    function resetToDefaults() {
        if (confirm('Reset all transactions to defaults? This cannot be undone.')) {
            transactionData = [...DEFAULT_TRANSACTIONS];
            saveTransactions(transactionData);
            renderTransactionList();
        }
    }

    // Calculator UI
    function calc() {
        const val = document.getElementById('balance').value;
        if (!val) return alert('Enter balance');

        const bal = parseFloat(val);
        const start = new Date();
        start.setDate(start.getDate()+1);

        const res = process(bal, start);

        document.getElementById('start').textContent = `£${bal.toFixed(2)}`;
        const end = res.length ? res[res.length-1].bal : bal;
        document.getElementById('end').textContent = `£${end.toFixed(2)}`;
        document.getElementById('endCard').classList.toggle('warning', end < -2000);

        const tb = document.getElementById('tbody');
        tb.innerHTML = '';

        res.forEach(r => {
            const row = tb.insertRow();
            if (r.t.dir === 'IN') row.classList.add('income');
            if (r.bal < -2000) row.classList.add('overdraft');
            row.innerHTML = `
                <td>${r.t.name}</td>
                <td><span class="dir-badge dir-${r.t.dir.toLowerCase()}">${r.t.dir}</span></td>
                <td class="hide-mobile">${r.t.freq}</td>
                <td class="amt ${r.t.dir.toLowerCase()}">£${r.t.amt.toFixed(2)}</td>
                <td class="bal ${r.bal < -2000 ? 'warn' : ''}">£${r.bal.toFixed(2)}</td>
                <td>${r.d.toLocaleDateString('en-GB')}</td>
            `;
        });

        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('results').classList.add('show');
    }

    function reset() {
        document.getElementById('results').classList.remove('show');
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('balance').value = '';
        document.getElementById('balance').focus();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
        if (e.key === 'Enter' && document.activeElement.id === 'balance') calc();
        if (e.key === 'Escape') closeModal();
    });

    // Close modal on overlay click
    document.getElementById('transModal').addEventListener('click', e => {
        if (e.target.id === 'transModal') closeModal();
    });
    </script>
</body>
</html>
