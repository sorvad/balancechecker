<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>Balance Checker</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent-green: #00ff41;
            --accent-red: #ff1744;
            --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Courier New', Courier, monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        header {
            border: 2px solid var(--accent-green);
            padding: 20px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
        }

        h1 {
            font-size: clamp(24px, 5vw, 48px);
            font-weight: 700;
            color: var(--accent-green);
            text-transform: uppercase;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
        }

        .input-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 30px;
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--accent-green);
            text-transform: uppercase;
            font-size: 12px;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 18px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        input[type="number"]:focus {
            border-color: var(--accent-green);
            outline: none;
        }

        button {
            width: 100%;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            font-weight: 700;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            margin-top: 20px;
        }

        button:active { transform: scale(0.98); }

        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .results { display: none; }
        .results.show { display: block; }

        .balance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .balance-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 20px;
        }

        .balance-card.warning { border-color: var(--accent-red); }

        .balance-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .balance-card.warning .balance-value { color: var(--accent-red); }

        .transactions-table {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }

        thead {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            color: var(--accent-green);
            border-bottom: 2px solid var(--border);
        }

        tbody tr { border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: var(--bg-tertiary); }
        tbody tr.income { background: rgba(0,255,65,0.05); }
        tbody tr.overdraft { background: rgba(255,23,68,0.1); }

        td { padding: 10px 8px; }

        .dir-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
        }

        .dir-in { background: var(--accent-green); color: var(--bg-primary); }
        .dir-out { background: var(--bg-tertiary); border: 1px solid var(--border); }

        .amt { font-weight: 700; }
        .amt.out { color: var(--text-primary); }
        .amt.in { color: var(--accent-green); }

        .bal { font-weight: 700; }
        .bal.warn { color: var(--accent-red); }

        @media (max-width: 768px) {
            body { padding: 10px; }
            table { font-size: 11px; }
            th, td { padding: 8px 4px; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Balance Checker</h1>
            <div class="subtitle">Projects from tomorrow through end of month</div>
        </header>

        <div class="input-section" id="inputSection">
            <label for="balance">Current Balance (£)</label>
            <input type="number" id="balance" step="0.01" placeholder="0.00" autofocus>
            <button onclick="calc()">Calculate</button>
        </div>

        <div class="results" id="results">
            <div class="balance-summary">
                <div class="balance-card">
                    <div class="balance-label">Start</div>
                    <div class="balance-value" id="start">£0.00</div>
                </div>
                <div class="balance-card" id="endCard">
                    <div class="balance-label">End</div>
                    <div class="balance-value" id="end">£0.00</div>
                </div>
            </div>

            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Dir</th>
                            <th class="hide-mobile">Frequency</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

            <button class="secondary" onclick="reset()">New Calculation</button>
        </div>
    </div>

    <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('✅ ServiceWorker registered successfully');
                    console.log('Scope:', registration.scope);
                })
                .catch(err => {
                    console.error('❌ ServiceWorker registration failed:', err);
                });
        });
    } else {
        console.warn('⚠️ Service Workers not supported in this browser');
    }

    // Classes
    class Transaction {
        constructor(name, dir, amt) {
            this.name = name;
            this.dir = dir;
            this.amt = amt;
        }
        get freq() { return ''; }
        test(d) { return false; }
    }

    class Daily extends Transaction {
        get freq() { return 'Daily'; }
        test() { return true; }
    }

    class Group extends Transaction {
        get freq() { return 'For Period'; }
        test() { return true; }
    }

    class Monthly extends Transaction {
        constructor(name, dir, amt, day) {
            super(name, dir, amt);
            this.day = day;
        }
        get freq() {
            const s = this.day >= 11 && this.day <= 13 ? 'th' : ['th','st','nd','rd'][this.day%10] || 'th';
            return `Monthly (${this.day}${s})`;
        }
        test(d) {
            const dow = d.getDay();
            const weekend = dow === 0 || dow === 6;
            if (this.dir === 'IN') {
                if (weekend) return false;
                if (dow === 5) return d.getDate() === this.day || d.getDate()+1 === this.day || d.getDate()+2 === this.day;
                return d.getDate() === this.day;
            } else {
                if (weekend) return false;
                if (dow === 1) {
                    const sun = new Date(d); sun.setDate(d.getDate()-1);
                    const sat = new Date(d); sat.setDate(d.getDate()-2);
                    return d.getDate() === this.day || sun.getDate() === this.day || sat.getDate() === this.day;
                }
                return d.getDate() === this.day;
            }
        }
    }

    class EndMonth extends Transaction {
        get freq() { return 'End of Month'; }
        test(d) {
            if (this.dir !== 'IN') return false;
            const dow = d.getDay();
            if (dow === 0 || dow === 6) return false;
            const last = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
            if (dow === 5) return d.getDate() === last || d.getDate()+1 === last || d.getDate()+2 === last;
            return d.getDate() === last;
        }
    }

    class ThreeMonthly extends Transaction {
        constructor(name, dir, amt, day, startMon) {
            super(name, dir, amt);
            this.day = day;
            this.startMon = startMon;
        }
        get freq() {
            const ms = [0,3,6,9].map(o => new Date(2000, (this.startMon-1+o)%12).toLocaleDateString('en',{month:'short'})).join(',');
            return `3 Monthly (${ms})`;
        }
        test(d) {
            const valid = [0,3,6,9].map(o => ((this.startMon-1+o)%12)+1);
            return valid.includes(d.getMonth()+1) && d.getDate() === this.day;
        }
    }

    class Yearly extends Transaction {
        constructor(name, dir, amt, day, mon) {
            super(name, dir, amt);
            this.day = day;
            this.mon = mon;
        }
        get freq() {
            const mn = new Date(2000, this.mon-1).toLocaleDateString('en',{month:'long'});
            const s = this.day >= 11 && this.day <= 13 ? 'th' : ['th','st','nd','rd'][this.day%10] || 'th';
            return `Yearly (${this.day}${s} ${mn})`;
        }
        test(d) {
            return d.getDate() === this.day && d.getMonth()+1 === this.mon;
        }
    }

    // Transactions
    const trans = [
        new Daily("Weekly Shop", "OUT", 27),
        new Daily("Petrol", "OUT", 3.6),
        new Monthly("TV License", "OUT", 13, 1),
        new Monthly("Internet", "OUT", 24, 15),
        new Monthly("Google Drive", "OUT", 7.99, 11),
        new Monthly("Gas & Elec", "OUT", 215, 1),
        new Monthly("Car Ins", "OUT", 22, 8),
        new Monthly("Mortgage", "OUT", 240, 28),
        new Monthly("Phones", "OUT", 20, 27),
        new Monthly("Water", "OUT", 19, 1),
        new Monthly("Council Tax", "OUT", 143, 16),
        new Monthly("House Ins", "OUT", 17, 3),
        new Monthly("Credit Cards", "OUT", 3, 1),
        new Monthly("Car Tax", "OUT", 14, 1),
        new Monthly("Credit Debt", "OUT", 11, 27),
        new Monthly("Lotto", "OUT", 10, 24),
        new Monthly("Boiler", "OUT", 25, 22),
        new Monthly("Disney+", "OUT", 9, 24),
        new Monthly("Netflix", "OUT", 11, 22),
        new Monthly("AA Home", "OUT", 31, 25),
        new Monthly("Bus Pass", "OUT", 78, 4),
        new Monthly("Trust Fund", "OUT", 50, 1),
        new ThreeMonthly("Hosting", "OUT", 60, 25, 1),
        new Yearly("Domain 1", "OUT", 35, 14, 4),
        new Yearly("Domain 2", "OUT", 15, 28, 3),
        new EndMonth("Wage", "IN", 2260),
        new Monthly("Pension", "IN", 500, 9),
        new Monthly("Rent", "IN", 220, 28)
    ];

    // Process
    function process(bal, start) {
        const res = [];
        const grp = {};
        const last = new Date(start.getFullYear(), start.getMonth()+1, 0);
        let d = new Date(start);

        while (d <= last) {
            for (const t of trans) {
                if (!t.test(d)) continue;
                if (t instanceof Daily && t.name !== "Weekly Shop") {
                    if (!grp[t.name]) grp[t.name] = {t, amt:0};
                    grp[t.name].amt += t.amt;
                } else {
                    bal += t.dir === 'OUT' ? -t.amt : t.amt;
                    res.push({t, d: new Date(d), bal});
                }
            }
            d.setDate(d.getDate()+1);
        }

        for (const [name, data] of Object.entries(grp)) {
            const gt = new Group(name, data.t.dir, data.amt);
            bal += gt.dir === 'OUT' ? -gt.amt : gt.amt;
            res.push({t: gt, d: last, bal});
        }

        return res;
    }

    // UI
    function calc() {
        const val = document.getElementById('balance').value;
        if (!val) return alert('Enter balance');

        const bal = parseFloat(val);
        const start = new Date();
        start.setDate(start.getDate()+1);

        const res = process(bal, start);

        document.getElementById('start').textContent = `£${bal.toFixed(2)}`;
        const end = res.length ? res[res.length-1].bal : bal;
        document.getElementById('end').textContent = `£${end.toFixed(2)}`;
        document.getElementById('endCard').classList.toggle('warning', end < -2000);

        const tb = document.getElementById('tbody');
        tb.innerHTML = '';

        res.forEach(r => {
            const row = tb.insertRow();
            if (r.t.dir === 'IN') row.classList.add('income');
            if (r.bal < -2000) row.classList.add('overdraft');
            row.innerHTML = `
                <td>${r.t.name}</td>
                <td><span class="dir-badge dir-${r.t.dir.toLowerCase()}">${r.t.dir}</span></td>
                <td class="hide-mobile">${r.t.freq}</td>
                <td class="amt ${r.t.dir.toLowerCase()}">£${r.t.amt.toFixed(2)}</td>
                <td class="bal ${r.bal < -2000 ? 'warn' : ''}">£${r.bal.toFixed(2)}</td>
                <td>${r.d.toLocaleDateString('en-GB')}</td>
            `;
        });

        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('results').classList.add('show');
    }

    function reset() {
        document.getElementById('results').classList.remove('show');
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('balance').value = '';
        document.getElementById('balance').focus();
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Enter' && document.activeElement.id === 'balance') calc();
    });
    </script>
</body>
</html>
